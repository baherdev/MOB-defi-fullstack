# Docker Compose Production avec HTTPS (Traefik)

version: '3.8'

services:
  # Reverse Proxy Traefik avec Let's Encrypt
  traefik:
    image: traefik:v2.10
    container_name: mob-traefik
    command:
      # API et Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # Redirection HTTP → HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=votre-email@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"

      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard (à protéger en prod!)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt

    networks:
      - mob-network

  # Base de données MySQL
  database:
    image: mysql:8.0
    container_name: mob-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: mob_routing
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - mob-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend Symfony (PHP-FPM)
  backend:
    build:
      context: ./mob-routing-api
      dockerfile: Dockerfile
    container_name: mob-backend
    depends_on:
      database:
        condition: service_healthy
    environment:
      APP_ENV: prod
      APP_DEBUG: 0
      APP_SECRET: ${APP_SECRET}
      DATABASE_URL: mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@database:3306/mob_routing?serverVersion=8.0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE:-}
    volumes:
      - app_data:/app
    networks:
      - mob-network
    command: >
      sh -c "
        php bin/console lexik:jwt:generate-keypair --skip-if-exists &&
        php bin/console doctrine:migrations:migrate --no-interaction &&
        php-fpm
      "

  # Nginx pour servir le backend
  webserver:
    image: nginx:alpine
    container_name: mob-webserver
    depends_on:
      - backend
    volumes:
      - app_data:/app
      - ./mob-routing-api/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - mob-network
    labels:
      - "traefik.enable=true"

      # Router HTTP → HTTPS redirect
      - "traefik.http.routers.api-http.rule=Host(`api.votre-domaine.com`)"
      - "traefik.http.routers.api-http.entrypoints=web"

      # Router HTTPS
      - "traefik.http.routers.api.rule=Host(`api.votre-domaine.com`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=80"

      # Security Headers
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Frame-Options=DENY"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Content-Type-Options=nosniff"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-XSS-Protection=1; mode=block"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.Strict-Transport-Security=max-age=31536000; includeSubDomains"
      - "traefik.http.routers.api.middlewares=security-headers"

  # Frontend Vue.js
  frontend:
    build:
      context: ./mob-routing-frontend
      dockerfile: Dockerfile
    container_name: mob-frontend
    depends_on:
      - backend
    environment:
      VITE_API_BASE_URL: https://api.votre-domaine.com/api/v1
    networks:
      - mob-network
    labels:
      - "traefik.enable=true"

      # Router HTTP → HTTPS redirect
      - "traefik.http.routers.frontend-http.rule=Host(`votre-domaine.com`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"

      # Router HTTPS
      - "traefik.http.routers.frontend.rule=Host(`votre-domaine.com`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

      # Security Headers
      - "traefik.http.routers.frontend.middlewares=security-headers"

volumes:
  db_data:
  app_data:

networks:
  mob-network:
    driver: bridge
